<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Locals Coffee - Daily Challenge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,700;0,9..144,900;1,9..144,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    :root {
      --cream: #faf6f0;
      --cream-dark: #f0e8db;
      --espresso: #2c1a0e;
      --coffee: #6b3a1f;
      --amber: #c4622d;
      --latte: #d4a574;
      --foam: #f7f0e8;
    }

    * { font-family: 'DM Sans', sans-serif; }

    body {
      background-color: var(--cream);
      background-image: 
        radial-gradient(ellipse at 20% 20%, rgba(196, 98, 45, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(107, 58, 31, 0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 60% 10%, rgba(212, 165, 116, 0.08) 0%, transparent 40%);
      min-height: 100vh;
    }

    @keyframes rise {
      0% { opacity: 0; transform: translateY(0) scale(1); }
      50% { opacity: 0.7; }
      100% { opacity: 0; transform: translateY(-10px) scale(1.5); }
    }
    .steam { transform-origin: bottom center; animation: rise 2s infinite linear; opacity: 0; }
    .steam-1 { animation-delay: 0s; }
    .steam-2 { animation-delay: 0.4s; }
    .steam-3 { animation-delay: 0.8s; }
    
    .flip-card { perspective: 1000px; }
    .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
    .flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-front, .flip-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .flip-back { transform: rotateY(180deg); }

    .logo-text {
      font-family: 'Fraunces', serif;
      font-weight: 900;
      font-optical-sizing: auto;
    }

    .key-default {
      background: linear-gradient(145deg, #f5ede0, #ede0cc);
      border: 1px solid rgba(180, 140, 100, 0.25);
      box-shadow: 
        0 3px 0 rgba(150, 100, 60, 0.2),
        0 4px 8px rgba(100, 60, 20, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.7);
      color: #3d2010;
      font-weight: 600;
      letter-spacing: 0.03em;
      transition: all 0.08s ease;
    }

    .key-default:active {
      box-shadow: 
        0 1px 0 rgba(150, 100, 60, 0.2),
        0 1px 3px rgba(100, 60, 20, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      transform: translateY(2px);
    }

    .key-action {
      background: linear-gradient(145deg, #c4622d, #a8501f);
      border: 1px solid rgba(100, 40, 10, 0.3);
      box-shadow: 
        0 3px 0 rgba(100, 40, 10, 0.35),
        0 4px 8px rgba(100, 40, 10, 0.15),
        inset 0 1px 0 rgba(255, 200, 150, 0.3);
      color: #fff;
      font-weight: 700;
      transition: all 0.08s ease;
    }

    .key-action:active {
      box-shadow: 
        0 1px 0 rgba(100, 40, 10, 0.35),
        0 1px 3px rgba(100, 40, 10, 0.2),
        inset 0 1px 0 rgba(255, 200, 150, 0.2);
      transform: translateY(2px);
    }

    .tile-empty {
      background: linear-gradient(145deg, #fdf9f4, #f5ede0);
      border: 2px solid rgba(180, 140, 100, 0.2);
      box-shadow: inset 0 1px 3px rgba(150, 100, 60, 0.05);
    }

    .tile-active {
      background: linear-gradient(145deg, #fff9f5, #fdf0e5);
      border: 2px solid rgba(196, 98, 45, 0.4);
      box-shadow: inset 0 1px 3px rgba(196, 98, 45, 0.08), 0 0 0 3px rgba(196, 98, 45, 0.08);
    }

    .game-card {
      background: rgba(255, 252, 248, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(180, 140, 100, 0.2);
      box-shadow: 
        0 20px 60px rgba(100, 60, 20, 0.12),
        0 4px 16px rgba(100, 60, 20, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .game-badge {
      background: linear-gradient(135deg, rgba(196, 98, 45, 0.1), rgba(212, 165, 116, 0.15));
      border: 1px solid rgba(196, 98, 45, 0.2);
      color: #6b3a1f;
    }

    .stat-pill {
      background: rgba(255, 252, 248, 0.8);
      border: 1px solid rgba(180, 140, 100, 0.2);
      box-shadow: 0 2px 8px rgba(100, 60, 20, 0.06);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up { animation: fadeInUp 0.4s ease forwards; }

    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      70% { transform: scale(1.03); }
      100% { transform: scale(1); opacity: 1; }
    }
    .pop-in { animation: popIn 0.3s ease forwards; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJHsW0CV5-pIyi1GVVldJPLyDNH89L29M",
      authDomain: "locals-v1.firebaseapp.com",
      projectId: "locals-v1",
      storageBucket: "locals-v1.firebasestorage.app",
      messagingSenderId: "978401457078",
      appId: "1:784014573078:web:c51f07ec6d273b9a5e7f37"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const successSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3');

    const Coffee = () => (
      <svg className="w-full h-full overflow-visible" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path className="steam steam-1 text-stone-300" d="M8 3 Q 9 1 10 3" strokeWidth="2" strokeLinecap="round" />
        <path className="steam steam-2 text-stone-300" d="M12 2 Q 13 0 14 2" strokeWidth="2" strokeLinecap="round" />
        <path className="steam steam-3 text-stone-300" d="M16 3 Q 17 1 18 3" strokeWidth="2" strokeLinecap="round" />
        <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
        <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
      </svg>
    );
    const Trophy = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
    const Flame = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>;
    const Undo2 = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>;
    const HelpIcon = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
    const XIcon = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;

    const HelpModal = ({ gameName, onClose }) => {
      const instructions = {
        'Sudoku': (
          <>
            <p className="mb-3 text-stone-600">Fill the grid so that every row, column, and 3√ó3 box contains the numbers 1 to 9.</p>
            <ul className="space-y-2 text-sm text-stone-500">
              <li className="flex gap-2"><span className="text-amber-600">‚Üí</span> Tap a cell to select it.</li>
              <li className="flex gap-2"><span className="text-amber-600">‚Üí</span> Tap a number below to fill it.</li>
              <li className="flex gap-2"><span className="text-amber-600">‚Üí</span> No duplicates in any row or column!</li>
            </ul>
          </>
        ),
        'Memory Match': (
          <>
            <p className="mb-3 text-stone-600">Find all the matching pairs of coffee icons.</p>
            <ul className="space-y-2 text-sm text-stone-500">
              <li className="flex gap-2"><span className="text-amber-600">‚Üí</span> Tap a card to flip it over.</li>
              <li className="flex gap-2"><span className="text-amber-600">‚Üí</span> Try to remember what you saw!</li>
              <li className="flex gap-2"><span className="text-amber-600">‚Üí</span> Match all pairs to win your discount.</li>
            </ul>
          </>
        ),
        'Coffee Word': (
          <>
            <p className="mb-3 text-stone-600">Guess the 5-letter coffee word in 6 tries.</p>
            <ul className="space-y-2 text-sm text-stone-500">
              <li className="flex gap-2 items-center"><span className="bg-green-500 text-white px-2 py-0.5 rounded text-xs font-bold">Green</span> correct letter & spot.</li>
              <li className="flex gap-2 items-center"><span className="bg-yellow-500 text-white px-2 py-0.5 rounded text-xs font-bold">Yellow</span> right letter, wrong spot.</li>
              <li className="flex gap-2 items-center"><span className="bg-stone-400 text-white px-2 py-0.5 rounded text-xs font-bold">Gray</span> letter not in word.</li>
            </ul>
          </>
        )
      };

      return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-3xl p-7 max-w-sm w-full shadow-2xl relative pop-in" onClick={e => e.stopPropagation()}>
            <button onClick={onClose} className="absolute top-4 right-4 w-8 h-8 text-stone-300 hover:text-stone-600 transition-colors"><XIcon/></button>
            <div className="mb-5">
              <p className="text-xs font-semibold text-amber-600 uppercase tracking-widest mb-1">How to play</p>
              <h3 className="text-2xl font-bold text-stone-900" style={{fontFamily: 'Fraunces, serif'}}>{gameName}</h3>
            </div>
            <div className="text-stone-700 mb-6">{instructions[gameName]}</div>
            <button onClick={onClose} className="w-full py-3 rounded-2xl font-bold text-white text-sm" style={{background: 'linear-gradient(135deg, #c4622d, #a8501f)', boxShadow: '0 4px 12px rgba(196, 98, 45, 0.3)'}}>Got it!</button>
          </div>
        </div>
      );
    };

    const SudokuGame = ({ onComplete }) => {
      const generatePuzzle = () => {
        const date = new Date().toDateString();
        const seed = date.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const base = [[5,3,4,6,7,8,9,1,2],[6,7,2,1,9,5,3,4,8],[1,9,8,3,4,2,5,6,7],[8,5,9,7,6,1,4,2,3],[4,2,6,8,5,3,7,9,1],[7,1,3,9,2,4,8,5,6],[9,6,1,5,3,7,2,8,4],[2,8,7,4,1,9,6,3,5],[3,4,5,2,8,6,1,7,9]];
        const puzzle = base.map(row => [...row]);
        let removed = 0, rng = seed;
        while (removed < 40) {
          rng = (rng * 1103515245 + 12345) & 0x7fffffff;
          const row = rng % 9;
          rng = (rng * 1103515245 + 12345) & 0x7fffffff;
          const col = rng % 9;
          if (puzzle[row][col] !== 0) { puzzle[row][col] = 0; removed++; }
        }
        return { puzzle, solution: base };
      };

      const [state, setState] = useState(() => {
        try {
          const saved = localStorage.getItem('sudoku-state');
          if (saved && JSON.parse(saved).date === new Date().toDateString()) return JSON.parse(saved);
        } catch {}
        const { puzzle, solution } = generatePuzzle();
        return { board: puzzle.map(r=>[...r]), solution, initial: puzzle.map(r=>[...r]), selectedCell: null, date: new Date().toDateString() };
      });

      const [history, setHistory] = useState([]);
      useEffect(() => localStorage.setItem('sudoku-state', JSON.stringify(state)), [state]);

      const select = (r, c) => { if(state.initial[r][c]===0) setState({...state, selectedCell: [r,c]}); };
      const enter = (num) => {
        if (!state.selectedCell) return;
        const [r, c] = state.selectedCell;
        setHistory([...history, state.board.map(row => [...row])]);
        const newBoard = state.board.map(row => [...row]);
        newBoard[r][c] = num;
        setState({...state, board: newBoard});
      };
      const undo = () => {
        if(history.length === 0) return;
        setState({...state, board: history[history.length-1]});
        setHistory(history.slice(0,-1));
      };
      const check = () => {
        if (state.board.every((row, i) => row.every((cell, j) => cell === state.solution[i][j]))) {
          onComplete();
        } else {
          alert("Check your numbers again!");
        }
      };

      return (
        <div className="game-card rounded-3xl p-5">
          <div className="grid grid-cols-9 gap-0 border-2 border-stone-200 rounded-2xl overflow-hidden mb-4">
            {state.board.map((row, i) => row.map((cell, j) => (
              <div key={`${i}-${j}`} onClick={() => select(i,j)}
                className={`aspect-square flex items-center justify-center text-base font-bold
                  ${(j+1)%3===0 && j!==8 ? 'border-r-2 border-stone-300' : 'border-r border-stone-100'}
                  ${(i+1)%3===0 && i!==8 ? 'border-b-2 border-stone-300' : 'border-b border-stone-100'}
                  ${state.initial[i][j]!==0 ? 'text-stone-700' : 'text-amber-700'}
                  ${state.selectedCell?.[0]===i && state.selectedCell?.[1]===j ? 'ring-inset ring-2 ring-amber-400' : ''}`}
                style={{background: state.initial[i][j]!==0 ? '#f5ede0' : (state.selectedCell?.[0]===i && state.selectedCell?.[1]===j ? '#fdf0e5' : '#faf6f0')}}
              >{cell || ''}</div>
            )))}
          </div>
          <div className="flex justify-between mb-4">
            <button onClick={undo} className="key-default px-4 py-2 rounded-xl text-sm flex items-center gap-1.5">
              <div className="w-3.5 h-3.5 inline-block"><Undo2/></div>Undo
            </button>
            <button onClick={check} className="key-action px-6 py-2 rounded-xl text-sm">Submit</button>
          </div>
          <div className="grid grid-cols-5 gap-2">
            {[1,2,3,4,5,6,7,8,9].map(n => (
              <button key={n} onClick={()=>enter(n)} className="key-default aspect-square rounded-xl text-lg font-bold">{n}</button>
            ))}
            <button onClick={()=>enter(0)} className="key-action aspect-square rounded-xl font-bold text-sm">‚úï</button>
          </div>
        </div>
      );
    };

    const MemoryGame = ({ onComplete }) => {
      const icons = ['‚òï', 'ü•ê', 'ü•Ø', 'ü•õ', 'üç™', 'üç∞', 'ü•°', 'üç©'];
      const [cards, setCards] = useState(() => {
        const deck = [...icons, ...icons].sort(() => Math.random() - 0.5);
        return deck.map((icon, id) => ({ id, icon, flipped: false, matched: false }));
      });
      const [flipped, setFlipped] = useState([]);
      const [disabled, setDisabled] = useState(false);

      useEffect(() => {
        if (flipped.length === 2) {
          setDisabled(true);
          if (cards[flipped[0]].icon === cards[flipped[1]].icon) {
            setCards(prev => prev.map(c => flipped.includes(c.id) ? { ...c, matched: true } : c));
            setFlipped([]); setDisabled(false);
          } else {
            setTimeout(() => {
              setCards(prev => prev.map(c => flipped.includes(c.id) ? { ...c, flipped: false } : c));
              setFlipped([]); setDisabled(false);
            }, 1000);
          }
        }
      }, [flipped]);

      useEffect(() => { if (cards.every(c => c.matched)) onComplete(); }, [cards]);

      const handleClick = (id) => {
        if (disabled || flipped.includes(id) || cards[id].matched) return;
        setCards(prev => prev.map(c => c.id === id ? { ...c, flipped: true } : c));
        setFlipped(prev => [...prev, id]);
      };

      return (
        <div className="game-card rounded-3xl p-5">
          <div className="grid grid-cols-4 gap-2.5">
            {cards.map((card) => (
              <div key={card.id} onClick={() => handleClick(card.id)} className={`aspect-square cursor-pointer flip-card ${card.flipped || card.matched ? 'flipped' : ''}`}>
                <div className="flip-card-inner relative w-full h-full text-center">
                  <div className="flip-front rounded-2xl flex items-center justify-center" style={{background: 'linear-gradient(145deg, #e8d5bc, #d4b896)', border: '1px solid rgba(180,140,100,0.3)'}}>
                    <div className="w-5 h-5 text-stone-400 opacity-50"><Coffee/></div>
                  </div>
                  <div className={`flip-back rounded-2xl flex items-center justify-center text-2xl ${card.matched ? 'border border-green-300' : 'border border-amber-200'}`}
                    style={{background: card.matched ? '#f0fdf4' : '#fdf6ed'}}>
                    {card.icon}
                  </div>
                </div>
              </div>
            ))}
          </div>
          <p className="text-center mt-4 text-xs font-semibold text-stone-400 uppercase tracking-wider">Find all the matching pairs</p>
        </div>
      );
    };

    const WordleGame = ({ onComplete }) => {
      const WORDS = ['LATTE', 'ROAST', 'MOCHA', 'GRIND', 'BEANS', 'STEAM', 'AROMA', 'CREMA'];
      const target = useMemo(() => {
        const idx = Math.floor(Date.now() / 86400000) % WORDS.length;
        return WORDS[idx];
      }, []);

      const [guesses, setGuesses] = useState([]);
      const [current, setCurrent] = useState('');
      const [status, setStatus] = useState('playing');

      const handleKey = (k) => {
        if (status !== 'playing') return;
        if (k === 'ENTER') {
          if (current.length !== 5) return;
          const newGuesses = [...guesses, current];
          setGuesses(newGuesses);
          setCurrent('');
          if (current === target) { setStatus('won'); onComplete(); }
          else if (newGuesses.length === 6) { setStatus('lost'); alert(`The word was ${target}`); }
        } else if (k === 'DEL') {
          setCurrent(prev => prev.slice(0, -1));
        } else if (current.length < 5 && /^[A-Z]$/.test(k)) {
          setCurrent(prev => prev + k);
        }
      };

      const keys = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];

      const getTileColor = (letter, i) => {
        if (target[i] === letter) return 'bg-green-500 text-white border-green-500';
        if (target.includes(letter)) return 'bg-yellow-500 text-white border-yellow-500';
        return 'bg-stone-400 text-white border-stone-400';
      };

      return (
        <div className="game-card rounded-3xl p-5">
          <div className="grid grid-rows-6 gap-1.5 mb-5 max-w-[240px] mx-auto">
            {[...Array(6)].map((_, i) => (
              <div key={i} className="grid grid-cols-5 gap-1.5">
                {[...Array(5)].map((_, j) => {
                  const guess = guesses[i];
                  const letter = guess ? guess[j] : (i === guesses.length ? current[j] : '');
                  const isActive = !guess && i === guesses.length && current[j];
                  const color = guess ? getTileColor(letter, j) : '';
                  return (
                    <div key={j} className={`aspect-square rounded-lg font-bold text-lg flex items-center justify-center transition-all ${guess ? color + ' border-2' : isActive ? 'tile-active' : 'tile-empty'}`}
                      style={{fontFamily: 'Fraunces, serif'}}>
                      {letter}
                    </div>
                  );
                })}
              </div>
            ))}
          </div>

          <div className="flex flex-col gap-1.5">
            {keys.map((row, i) => (
              <div key={i} className="flex justify-center gap-1">
                {row.split('').map(char => (
                  <button
                    key={char}
                    onClick={() => handleKey(char)}
                    className="key-default rounded-lg font-bold"
                    style={{width: '30px', height: '40px', fontSize: '13px'}}
                  >{char}</button>
                ))}
                {i === 2 && (
                  <button
                    onClick={() => handleKey('DEL')}
                    className="key-action rounded-lg font-bold"
                    style={{width: '38px', height: '40px', fontSize: '16px'}}
                  >‚å´</button>
                )}
                {i === 2 && (
                  <button
                    onClick={() => handleKey('ENTER')}
                    className="key-action rounded-lg font-bold"
                    style={{width: '38px', height: '40px', fontSize: '16px'}}
                  >‚Üµ</button>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    };

    function Locals() {
      const [view, setView] = useState('game');
      const [showHelp, setShowHelp] = useState(false);

      const dayIndex = Math.floor(Date.now() / (1000 * 60 * 60 * 24));
      const gameType = dayIndex % 3;

      const GAME_CONFIG = {
        0: { id: 'sudoku', label: 'Boost Focus', name: 'Sudoku', objective: 'Fill every row, column & box with 1‚Äì9', Comp: SudokuGame },
        1: { id: 'memory', label: 'Sharpen Recall', name: 'Memory Match', objective: 'Find all matching coffee pairs', Comp: MemoryGame },
        2: { id: 'wordle', label: 'Expand Vocabulary', name: 'Coffee Word', objective: 'Guess the 5-letter word in 6 tries', Comp: WordleGame }
      };

      const currentGame = GAME_CONFIG[gameType];

      const adjectives = ['Swift', 'Clever', 'Bright', 'Quick', 'Sharp', 'Smart', 'Wise', 'Bold'];
      const nouns = ['Fox', 'Eagle', 'Tiger', 'Wolf', 'Bear', 'Hawk', 'Lion', 'Panda'];
      const colors = ['#c4622d', '#a86828', '#b07830', '#8b5e3c', '#c47832', '#9a6040'];

      const [userId] = useState(() => {
        try {
          const saved = localStorage.getItem('user-id');
          if (saved) return JSON.parse(saved);
          const newUser = { id: Math.random().toString(36).substr(2, 9), adjective: adjectives[Math.floor(Math.random()*8)], noun: nouns[Math.floor(Math.random()*8)], number: Math.floor(Math.random()*9000)+1000, color: colors[Math.floor(Math.random()*6)] };
          localStorage.setItem('user-id', JSON.stringify(newUser));
          return newUser;
        } catch { return { id: '123', adjective: 'Swift', noun: 'Fox', number: 1234, color: '#c4622d' }; }
      });

      const [userStats, setUserStats] = useState(() => {
        const saved = localStorage.getItem('user-stats');
        return saved ? JSON.parse(saved) : { totalCompletions: 0, currentStreak: 0, lastPlayedDate: null, consecutiveRedemptions: 0 };
      });
      useEffect(() => localStorage.setItem('user-stats', JSON.stringify(userStats)), [userStats]);

      const [completedToday, setCompletedToday] = useState(false);
      const [victoryData, setVictoryData] = useState(null);

      useEffect(() => {
        const today = new Date().toDateString();
        if (userStats.lastPlayedDate === today) setCompletedToday(true);
      }, []);

      const getSeqCode = async () => {
        try { const s = await db.collection('codes').get(); return s.size + 1; } catch { return 1; }
      };

      const handleGameComplete = async () => {
        if (completedToday) return;
        successSound.play().catch(e => console.log(e));
        const duration = 3000; const end = Date.now() + duration;
        const interval = setInterval(() => {
          if (Date.now() > end) return clearInterval(interval);
          confetti({ particleCount: 50, spread: 360, origin: { x: Math.random(), y: Math.random() - 0.2 } });
        }, 250);

        const date = new Date();
        const dateStr = `${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
        const seq = await getSeqCode();
        const code = `LOCAL-${dateStr}-${seq.toString().padStart(3,'0')}`;
        const isFree = userStats.consecutiveRedemptions >= 5;
        const discountPercent = isFree ? 100 : (Math.random() > 0.5 ? 10 : 5);

        const today = date.toDateString();
        let newStreak = 1;
        if (userStats.lastPlayedDate) {
          const diff = Math.floor((new Date(today) - new Date(userStats.lastPlayedDate)) / 86400000);
          if (diff === 1) newStreak = userStats.currentStreak + 1;
          else if (diff === 0) newStreak = userStats.currentStreak;
        }

        const newStats = { ...userStats, totalCompletions: userStats.totalCompletions + 1, currentStreak: newStreak, lastPlayedDate: today };
        setUserStats(newStats);

        try {
          await db.collection('codes').doc(code).set({
            code, userId: userId.id, userName: `${userId.adjective}${userId.noun}#${userId.number}`,
            date: today, discountPercent, isFree, game: currentGame.name
          });
        } catch(e) { console.error(e); }

        setVictoryData({ code, discountPercent, isFree });
        setCompletedToday(true);
      };

      const resetGame = () => {
        setCompletedToday(false);
        setVictoryData(null);
        window.location.reload();
      };

      const getName = () => `${userId.adjective}${userId.noun}#${userId.number}`;

      if (view === 'streaks') {
        return (
          <div className="min-h-screen p-4 fade-in-up">
            <div className="max-w-md mx-auto pt-8">
              <button onClick={() => setView('game')} className="text-stone-400 hover:text-stone-700 mb-6 flex items-center gap-1 text-sm font-semibold transition-colors">‚Üê Back</button>
              <div className="game-card rounded-3xl p-8">
                <div className="w-14 h-14 text-amber-600 mx-auto mb-4"><Flame /></div>
                <h2 className="text-3xl font-bold text-stone-900 mb-6 text-center" style={{fontFamily: 'Fraunces, serif'}}>Streak Rewards</h2>
                <div className="rounded-2xl p-5 mb-4 border" style={{background: 'rgba(196, 98, 45, 0.06)', borderColor: 'rgba(196, 98, 45, 0.15)'}}>
                  <h3 className="text-base font-bold mb-1 text-stone-800">Daily Reward</h3>
                  <p className="text-sm text-stone-500">Complete the daily game ‚Üí Get a <strong className="text-stone-700">discount</strong></p>
                </div>
                <div className="rounded-2xl p-5 border" style={{background: 'rgba(34, 197, 94, 0.05)', borderColor: 'rgba(34, 197, 94, 0.15)'}}>
                  <h3 className="text-base font-bold mb-1 text-stone-800">üèÜ Streak Bonus</h3>
                  <p className="text-sm text-stone-500 mb-2">Complete & redeem <strong className="text-stone-700">5 days in a row</strong></p>
                  <p className="text-xl font-black text-green-600">6th coffee FREE! ‚òï</p>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen p-4 flex flex-col items-center justify-center">
          <div className="max-w-md w-full relative fade-in-up">

            {showHelp && <HelpModal gameName={currentGame.name} onClose={() => setShowHelp(false)} />}

            <div className="text-center mb-5 relative">
              <button onClick={() => setShowHelp(true)} className="absolute top-0 right-0 p-2 text-stone-300 hover:text-amber-600 transition-colors">
                <div className="w-5 h-5"><HelpIcon /></div>
              </button>

              <div className="flex items-center justify-center gap-3 mb-1">
                <div className="w-10 h-10 text-amber-600 mt-1"><Coffee /></div>
                <h1 className="logo-text text-5xl" style={{color: '#c4622d', letterSpacing: '-0.02em'}}>Locals</h1>
              </div>

              <p className="text-stone-400 text-sm font-medium italic mb-3">{currentGame.label} ¬∑ Stay Sharp</p>

              <div className="inline-flex items-center gap-2 game-badge rounded-full px-4 py-1.5 mb-2">
                <span className="text-xs font-bold uppercase tracking-widest">{currentGame.name}</span>
              </div>

              <p className="text-xs text-stone-400 font-medium mb-4">{currentGame.objective}</p>

              <div className="flex items-center justify-center gap-4">
                <div className="stat-pill rounded-full px-3 py-1.5 flex items-center gap-1.5 cursor-pointer" onClick={() => setView('streaks')}>
                  <div className="w-4 h-4 text-orange-500"><Flame /></div>
                  <span className="font-bold text-sm text-stone-700">{userStats.currentStreak}</span>
                  <span className="text-xs text-stone-400 font-medium">streak</span>
                </div>

                <div className="flex items-center gap-1.5">
                  <div className="w-2 h-2 rounded-full" style={{ backgroundColor: userId.color }}></div>
                  <span className="text-xs font-bold text-stone-500">{getName()}</span>
                </div>

                <div className="stat-pill rounded-full px-3 py-1.5 flex items-center gap-1.5">
                  <div className="w-4 h-4 text-amber-600"><Trophy /></div>
                  <span className="font-bold text-sm text-stone-700">{userStats.totalCompletions}</span>
                  <span className="text-xs text-stone-400 font-medium">wins</span>
                </div>
              </div>
            </div>

            {victoryData ? (
              <div className="game-card rounded-3xl p-8 text-center pop-in">
                <div className="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" style={{background: 'linear-gradient(135deg, #c4622d, #a8501f)', boxShadow: '0 8px 24px rgba(196, 98, 45, 0.3)'}}>
                  <div className="w-8 h-8 text-white"><Trophy /></div>
                </div>
                <h2 className="text-3xl font-bold mb-1 text-stone-900" style={{fontFamily: 'Fraunces, serif'}}>Victory!</h2>
                <p className="text-stone-400 text-sm mb-5">Show this to your barista</p>
                <div className="rounded-2xl p-6 mb-5" style={{background: 'linear-gradient(135deg, #c4622d, #8b4513)', boxShadow: '0 8px 32px rgba(196, 98, 45, 0.25)'}}>
                  <div className="text-2xl font-mono font-bold text-white/80 mb-1 tracking-wider">{victoryData.code}</div>
                  {victoryData.isFree ? (
                    <div className="text-3xl font-black text-white">FREE COFFEE ‚òï</div>
                  ) : (
                    <div className="text-3xl font-black text-white">{victoryData.discountPercent}% OFF</div>
                  )}
                </div>
                <button onClick={resetGame} className="key-default w-full py-3 rounded-2xl font-bold text-sm">Play Again (Just for fun)</button>
              </div>
            ) : (
              <currentGame.Comp onComplete={handleGameComplete} />
            )}

          </div>
        </div>
      );
    }

    ReactDOM.render(<Locals />, document.getElementById('root'));
  </script>
</body>
</html>
