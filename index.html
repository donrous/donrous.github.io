<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Locals Coffee - Daily Challenge</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <style>
    @keyframes rise {
      0% { opacity: 0; transform: translateY(0) scale(1); }
      50% { opacity: 0.7; }
      100% { opacity: 0; transform: translateY(-10px) scale(1.5); }
    }
    .steam { transform-origin: bottom center; animation: rise 2s infinite linear; opacity: 0; }
    .steam-1 { animation-delay: 0s; }
    .steam-2 { animation-delay: 0.4s; }
    .steam-3 { animation-delay: 0.8s; }
    .flip-card { perspective: 1000px; }
    .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
    .flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-front, .flip-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .flip-back { transform: rotateY(180deg); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJHsW0CV5-pIyi1GVVldJPLyDNH89L29M",
      authDomain: "locals-v1.firebaseapp.com",
      projectId: "locals-v1",
      storageBucket: "locals-v1.firebasestorage.app",
      messagingSenderId: "978401457078",
      appId: "1:784014573078:web:c51f07ec6d273b9a5e7f37"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const successSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3');

    // --- ICONS ---
    const Coffee = () => (
      <svg className="w-full h-full overflow-visible" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path className="steam steam-1 text-stone-300" d="M8 3 Q 9 1 10 3" strokeWidth="2" strokeLinecap="round" />
        <path className="steam steam-2 text-stone-300" d="M12 2 Q 13 0 14 2" strokeWidth="2" strokeLinecap="round" />
        <path className="steam steam-3 text-stone-300" d="M16 3 Q 17 1 18 3" strokeWidth="2" strokeLinecap="round" />
        <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
        <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
      </svg>
    );
    const Trophy = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
    const Flame = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>;
    const Undo2 = () => <svg className="w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>;

    // --- GAME 1: SUDOKU LOGIC ---
    const SudokuGame = ({ onComplete }) => {
      const generatePuzzle = () => {
        const date = new Date().toDateString();
        const seed = date.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const base = [[5,3,4,6,7,8,9,1,2],[6,7,2,1,9,5,3,4,8],[1,9,8,3,4,2,5,6,7],[8,5,9,7,6,1,4,2,3],[4,2,6,8,5,3,7,9,1],[7,1,3,9,2,4,8,5,6],[9,6,1,5,3,7,2,8,4],[2,8,7,4,1,9,6,3,5],[3,4,5,2,8,6,1,7,9]];
        const puzzle = base.map(row => [...row]);
        let removed = 0, rng = seed;
        while (removed < 40) {
          rng = (rng * 1103515245 + 12345) & 0x7fffffff;
          const row = rng % 9;
          rng = (rng * 1103515245 + 12345) & 0x7fffffff;
          const col = rng % 9;
          if (puzzle[row][col] !== 0) { puzzle[row][col] = 0; removed++; }
        }
        return { puzzle, solution: base };
      };

      const [state, setState] = useState(() => {
        try {
          const saved = localStorage.getItem('sudoku-state');
          if (saved && JSON.parse(saved).date === new Date().toDateString()) return JSON.parse(saved);
        } catch {}
        const { puzzle, solution } = generatePuzzle();
        return { board: puzzle.map(r=>[...r]), solution, initial: puzzle.map(r=>[...r]), selectedCell: null, date: new Date().toDateString() };
      });

      const [history, setHistory] = useState([]);

      useEffect(() => localStorage.setItem('sudoku-state', JSON.stringify(state)), [state]);

      const select = (r, c) => { if(state.initial[r][c]===0) setState({...state, selectedCell: [r,c]}); };
      
      const enter = (num) => {
        if (!state.selectedCell) return;
        const [r, c] = state.selectedCell;
        setHistory([...history, state.board.map(row => [...row])]);
        const newBoard = state.board.map(row => [...row]);
        newBoard[r][c] = num;
        setState({...state, board: newBoard});
      };

      const undo = () => {
        if(history.length === 0) return;
        setState({...state, board: history[history.length-1]});
        setHistory(history.slice(0,-1));
      };

      const check = () => {
        if (state.board.every((row, i) => row.every((cell, j) => cell === state.solution[i][j]))) {
          onComplete();
        } else {
          alert("Check your numbers again!");
        }
      };

      return (
        <div className="bg-white/80 border-2 border-stone-200 rounded-3xl shadow-2xl p-6">
          <div className="grid grid-cols-9 gap-0 border-4 border-stone-300 rounded-2xl overflow-hidden mb-4">
            {state.board.map((row, i) => row.map((cell, j) => (
              <div key={`${i}-${j}`} onClick={() => select(i,j)}
                className={`aspect-square flex items-center justify-center text-lg font-bold
                  ${(j+1)%3===0 && j!==8 ? 'border-r-4 border-stone-400' : 'border-r border-stone-300'}
                  ${(i+1)%3===0 && i!==8 ? 'border-b-4 border-stone-400' : 'border-b border-stone-300'}
                  ${state.initial[i][j]!==0 ? 'bg-stone-100 text-stone-800' : 'bg-white text-amber-700'}
                  ${state.selectedCell?.[0]===i && state.selectedCell?.[1]===j ? 'bg-amber-100 ring-2 ring-amber-500' : ''}`}
              >{cell || ''}</div>
            )))}
          </div>
          <div className="flex justify-between mb-4">
             <button onClick={undo} className="px-4 py-2 bg-stone-100 rounded-xl font-bold text-stone-500"><div className="w-4 h-4 inline-block mr-1"><Undo2/></div>Undo</button>
             <button onClick={check} className="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-bold">Submit</button>
          </div>
          <div className="grid grid-cols-5 gap-2">
            {[1,2,3,4,5,6,7,8,9].map(n => (
              <button key={n} onClick={()=>enter(n)} className="aspect-square rounded-xl text-xl font-bold bg-stone-100 text-stone-600 active:bg-amber-500 active:text-white">{n}</button>
            ))}
            <button onClick={()=>enter(0)} className="aspect-square rounded-xl font-bold bg-red-50 text-red-500">X</button>
          </div>
        </div>
      );
    };

    // --- GAME 2: MEMORY MATCH LOGIC ---
    const MemoryGame = ({ onComplete }) => {
      const icons = ['‚òï', 'ü•ê', 'ü•Ø', 'ü•õ', 'üç™', 'üç∞', 'ü•°', 'üç©']; 
      
      const [cards, setCards] = useState(() => {
         // Shuffle consistently for the day or random? Random is fine for memory.
         const deck = [...icons, ...icons].sort(() => Math.random() - 0.5);
         return deck.map((icon, id) => ({ id, icon, flipped: false, matched: false }));
      });
      const [flipped, setFlipped] = useState([]);
      const [disabled, setDisabled] = useState(false);

      useEffect(() => {
        if (flipped.length === 2) {
          setDisabled(true);
          if (cards[flipped[0]].icon === cards[flipped[1]].icon) {
            setCards(prev => prev.map(c => flipped.includes(c.id) ? { ...c, matched: true } : c));
            setFlipped([]);
            setDisabled(false);
          } else {
            setTimeout(() => {
              setCards(prev => prev.map(c => flipped.includes(c.id) ? { ...c, flipped: false } : c));
              setFlipped([]);
              setDisabled(false);
            }, 1000);
          }
        }
      }, [flipped]);

      useEffect(() => {
        if (cards.every(c => c.matched)) onComplete();
      }, [cards]);

      const handleClick = (id) => {
        if (disabled || flipped.includes(id) || cards[id].matched) return;
        setCards(prev => prev.map(c => c.id === id ? { ...c, flipped: true } : c));
        setFlipped(prev => [...prev, id]);
      };

      return (
        <div className="bg-white/80 border-2 border-stone-200 rounded-3xl shadow-2xl p-6">
          <div className="grid grid-cols-4 gap-3">
            {cards.map((card) => (
              <div key={card.id} onClick={() => handleClick(card.id)} className={`aspect-square cursor-pointer flip-card ${card.flipped || card.matched ? 'flipped' : ''}`}>
                 <div className="flip-card-inner relative w-full h-full text-center">
                    <div className="flip-front bg-stone-200 rounded-xl flex items-center justify-center border-2 border-stone-300">
                      <div className="w-6 h-6 text-stone-400"><Coffee/></div>
                    </div>
                    <div className={`flip-back rounded-xl flex items-center justify-center text-3xl border-2 ${card.matched ? 'bg-green-100 border-green-500' : 'bg-white border-amber-600'}`}>
                      {card.icon}
                    </div>
                 </div>
              </div>
            ))}
          </div>
          <p className="text-center mt-4 text-stone-500 font-bold">Find all the matching pairs!</p>
        </div>
      );
    };

    // --- GAME 3: COFFEE WORDLE LOGIC ---
    const WordleGame = ({ onComplete }) => {
      const WORDS = ['LATTE', 'ROAST', 'MOCHA', 'GRIND', 'BEANS', 'STEAM', 'AROMA', 'CREMA'];
      // Select word based on date so everyone gets the same one
      const target = useMemo(() => {
        const idx = Math.floor(Date.now() / 86400000) % WORDS.length;
        return WORDS[idx];
      }, []);

      const [guesses, setGuesses] = useState([]);
      const [current, setCurrent] = useState('');
      const [status, setStatus] = useState('playing'); // playing, won, lost

      const handleKey = (k) => {
        if (status !== 'playing') return;
        if (k === 'ENTER') {
          if (current.length !== 5) return;
          const newGuesses = [...guesses, current];
          setGuesses(newGuesses);
          setCurrent('');
          if (current === target) {
            setStatus('won');
            onComplete();
          } else if (newGuesses.length === 6) {
            setStatus('lost');
            alert(`The word was ${target}`);
          }
        } else if (k === 'DEL') {
          setCurrent(prev => prev.slice(0, -1));
        } else if (current.length < 5 && /^[A-Z]$/.test(k)) {
          setCurrent(prev => prev + k);
        }
      };

      // Keyboard
      const keys = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];

      const getTileColor = (letter, i, guess) => {
        if (target[i] === letter) return 'bg-green-500 text-white border-green-500';
        if (target.includes(letter)) return 'bg-yellow-500 text-white border-yellow-500';
        return 'bg-stone-400 text-white border-stone-400';
      };

      return (
        <div className="bg-white/80 border-2 border-stone-200 rounded-3xl shadow-2xl p-6">
           <div className="grid grid-rows-6 gap-2 mb-4 max-w-[250px] mx-auto">
             {[...Array(6)].map((_, i) => (
               <div key={i} className="grid grid-cols-5 gap-2">
                 {[...Array(5)].map((_, j) => {
                   const guess = guesses[i];
                   const letter = guess ? guess[j] : (i === guesses.length ? current[j] : '');
                   const color = guess ? getTileColor(letter, j, guess) : 'bg-white border-stone-300 text-stone-800';
                   return <div key={j} className={`aspect-square border-2 rounded font-bold text-xl flex items-center justify-center ${color}`}>{letter}</div>
                 })}
               </div>
             ))}
           </div>
           
           <div className="flex flex-col gap-2">
             {keys.map((row, i) => (
               <div key={i} className="flex justify-center gap-1">
                 {row.split('').map(char => (
                   <button key={char} onClick={() => handleKey(char)} className="px-2 py-3 bg-stone-200 rounded font-bold text-xs sm:text-sm active:bg-stone-400">{char}</button>
                 ))}
                 {i === 2 && <button onClick={() => handleKey('DEL')} className="px-3 py-3 bg-red-100 text-red-600 rounded font-bold text-xs">‚å´</button>}
                 {i === 2 && <button onClick={() => handleKey('ENTER')} className="px-3 py-3 bg-green-100 text-green-600 rounded font-bold text-xs">‚Üµ</button>}
               </div>
             ))}
           </div>
        </div>
      );
    };

    // --- MAIN APP ---
    function Locals() {
      const [view, setView] = useState('game');
      // Game Rotation Logic
      const dayIndex = Math.floor(Date.now() / (1000 * 60 * 60 * 24));
      // 0 = Sudoku, 1 = Memory, 2 = Wordle
      const gameType = dayIndex % 3; 
      
      const GAME_CONFIG = {
        0: { id: 'sudoku', label: 'Boost Focus', name: 'Sudoku', Comp: SudokuGame },
        1: { id: 'memory', label: 'Sharpen Recall', name: 'Memory Match', Comp: MemoryGame },
        2: { id: 'wordle', label: 'Expand Vocabulary', name: 'Coffee Word', Comp: WordleGame }
      };

      const currentGame = GAME_CONFIG[gameType];

      // --- USER & STATS LOGIC (Shared) ---
      const adjectives = ['Swift', 'Clever', 'Bright', 'Quick', 'Sharp', 'Smart', 'Wise', 'Bold'];
      const nouns = ['Fox', 'Eagle', 'Tiger', 'Wolf', 'Bear', 'Hawk', 'Lion', 'Panda'];
      const colors = ['#d4af37', '#ffd700', '#c9b037', '#b8860b', '#daa520', '#f4c430'];

      const [userId] = useState(() => {
        try {
          const saved = localStorage.getItem('user-id');
          if (saved) return JSON.parse(saved);
          const newUser = { id: Math.random().toString(36).substr(2, 9), adjective: adjectives[Math.floor(Math.random()*8)], noun: nouns[Math.floor(Math.random()*8)], number: Math.floor(Math.random()*9000)+1000, color: colors[Math.floor(Math.random()*6)] };
          localStorage.setItem('user-id', JSON.stringify(newUser));
          return newUser;
        } catch { return { id: '123', adjective: 'Swift', noun: 'Fox', number: 1234, color: '#d4af37' }; }
      });

      const [userStats, setUserStats] = useState(() => {
        const saved = localStorage.getItem('user-stats');
        return saved ? JSON.parse(saved) : { totalCompletions: 0, currentStreak: 0, lastPlayedDate: null, consecutiveRedemptions: 0 };
      });
      useEffect(() => localStorage.setItem('user-stats', JSON.stringify(userStats)), [userStats]);

      // --- VICTORY STATE ---
      const [completedToday, setCompletedToday] = useState(false);
      const [victoryData, setVictoryData] = useState(null);

      // Check if already played today
      useEffect(() => {
         const today = new Date().toDateString();
         if (userStats.lastPlayedDate === today) {
            setCompletedToday(true);
            // If they reload, we don't show the code again immediately in this simple version, 
            // or we could save the daily code in localStorage. 
            // For now, let's just let them play again for fun or show a "Done" screen.
         }
      }, []);

      const getSeqCode = async () => {
        try { const s = await db.collection('codes').get(); return s.size + 1; } catch { return 1; }
      };

      const handleGameComplete = async () => {
        if (completedToday) return; // Already triggered

        // 1. Audio & Confetti
        successSound.play().catch(e=>console.log(e));
        const duration = 3000; const end = Date.now() + duration;
        const interval = setInterval(() => {
          if (Date.now() > end) return clearInterval(interval);
          confetti({ particleCount: 50, spread: 360, origin: { x: Math.random(), y: Math.random() - 0.2 } });
        }, 250);

        // 2. Data Calculation
        const date = new Date();
        const dateStr = `${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
        const seq = await getSeqCode();
        const code = `LOCAL-${dateStr}-${seq.toString().padStart(3,'0')}`;
        const isFree = userStats.consecutiveRedemptions >= 5;
        const discountPercent = isFree ? 100 : (Math.random() > 0.5 ? 10 : 5); // Simple logic for non-sudoku games

        // 3. Streak Logic
        const today = date.toDateString();
        let newStreak = 1;
        if (userStats.lastPlayedDate) {
          const diff = Math.floor((new Date(today) - new Date(userStats.lastPlayedDate)) / 86400000);
          if (diff === 1) newStreak = userStats.currentStreak + 1;
          else if (diff === 0) newStreak = userStats.currentStreak;
        }

        const newStats = { 
          ...userStats, 
          totalCompletions: userStats.totalCompletions + 1, 
          currentStreak: newStreak, 
          lastPlayedDate: today 
        };
        setUserStats(newStats);

        // 4. Save to Firebase
        try {
          await db.collection('codes').doc(code).set({
             code, userId: userId.id, userName: `${userId.adjective}${userId.noun}#${userId.number}`,
             date: today, discountPercent, isFree, game: currentGame.name
          });
        } catch(e) { console.error(e); }

        // 5. Show Victory
        setVictoryData({ code, discountPercent, isFree });
        setCompletedToday(true);
      };

      const resetGame = () => {
        // Allow replay for fun, but don't give new code
        setCompletedToday(false);
        setVictoryData(null);
        window.location.reload(); // Simplest way to reset internal game states
      };

      const getName = () => `${userId.adjective}${userId.noun}#${userId.number}`;

      // --- RENDER STREAK VIEW ---
      if (view === 'streaks') {
        const prog = userStats.consecutiveRedemptions % 6;
        return (
          <div className="min-h-screen bg-gradient-to-br from-stone-50 via-amber-50 to-orange-50 p-4">
            <div className="max-w-md mx-auto">
              <button onClick={() => setView('game')} className="text-stone-600 mb-4">‚Üê Back</button>
              <div className="bg-white/80 border-2 border-stone-200 rounded-3xl shadow-2xl p-8">
                <div className="w-16 h-16 text-orange-500 mx-auto mb-4"><Flame /></div>
                <h2 className="text-3xl font-bold text-stone-900 mb-6 text-center">Streak Rewards</h2>
                <div className="bg-orange-50 rounded-2xl p-6 mb-6 border-2 border-orange-200">
                  <h3 className="text-xl font-bold mb-2">Daily Reward</h3>
                  <p>Complete the daily game ‚Üí Get <strong>Discount</strong></p>
                </div>
                <div className="bg-green-50 rounded-2xl p-6 mb-6 border-2 border-green-200">
                  <h3 className="text-xl font-bold mb-2">üèÜ Streak Bonus</h3>
                  <p className="mb-2"><strong>Complete & redeem 5 days in a row</strong></p>
                  <p className="text-2xl font-black text-green-600">6th coffee FREE! ‚òï</p>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // --- RENDER GAME VIEW ---
      return (
        <div className="min-h-screen bg-gradient-to-br from-stone-50 via-amber-50 to-orange-50 p-4 flex flex-col items-center justify-center">
          <div className="max-w-md w-full">
            
            {/* HEADER */}
            <div className="text-center mb-8">
              <div className="flex items-center justify-center gap-4 mb-1">
                <div className="w-12 h-12 text-amber-600 mt-2"><Coffee /></div>
                <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-700 to-orange-600">Locals</h1>
              </div>
              <p className="text-stone-500 font-medium italic mb-4">{currentGame.label} - Stay Sharp</p>
              
              <div className="bg-white/50 backdrop-blur rounded-full px-4 py-1 inline-block mb-3 border border-stone-200">
                 <p className="text-sm font-bold text-stone-600 uppercase tracking-wider">{currentGame.name}</p>
              </div>

              <div className="flex items-center justify-center gap-2 mb-3">
                <div className="w-2 h-2 rounded-full" style={{ backgroundColor: userId.color }}></div>
                <span className="text-sm font-bold" style={{ color: userId.color }}>{getName()}</span>
              </div>
              
              <div className="flex justify-center gap-6 mt-4">
                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('streaks')}><div className="w-5 h-5 text-orange-500"><Flame /></div><span className="font-bold text-lg">{userStats.currentStreak}</span></div>
                <div className="flex items-center gap-2"><div className="w-5 h-5 text-amber-600"><Trophy /></div><span className="font-bold text-lg">{userStats.totalCompletions}</span></div>
              </div>
            </div>

            {/* VICTORY SCREEN */}
            {victoryData ? (
              <div className="bg-white/80 border-2 border-stone-200 rounded-3xl shadow-2xl p-8 mb-6 text-center">
                <div className="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                  <div className="w-12 h-12 text-white"><Trophy /></div>
                </div>
                <h2 className="text-3xl font-bold mb-2">Victory!</h2>
                <div className="bg-gradient-to-r from-amber-600 to-orange-600 rounded-2xl p-6 mb-4 shadow-xl">
                  <div className="text-3xl font-mono font-bold text-white mb-2">{victoryData.code}</div>
                  {victoryData.isFree ? (
                    <div className="text-3xl font-black text-white">FREE COFFEE ‚òï</div>
                  ) : (
                    <div className="text-2xl font-black text-white">{victoryData.discountPercent}% OFF</div>
                  )}
                </div>
                <p className="text-sm font-bold text-stone-600 mb-4">Show this to the barista!</p>
                <button onClick={resetGame} className="bg-stone-800 text-white px-8 py-3 rounded-xl font-bold mt-4">Play Again (Just for fun)</button>
              </div>
            ) : (
              // ACTIVE GAME COMPONENT
              <currentGame.Comp onComplete={handleGameComplete} />
            )}

          </div>
        </div>
      );
    }

    ReactDOM.render(<Locals />, document.getElementById('root'));
  </script>
</body>
</html>
